<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <title>MegaBingo</title>

  <!-- âœ… æ‰‹æ©Ÿèˆ‡è·¨ç€è¦½å™¨ç›¸å®¹æ€§è¨­å®š -->
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1, minimum-scale=1,maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="renderer" content="webkit" />
  <meta name="force-rendering" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="full-screen" content="yes" />
  <meta name="x5-fullscreen" content="true" />
  <meta name="360-fullscreen" content="true" />
  <meta name="screen-orientation" content="" />
  <meta name="x5-orientation" content="">
  <meta name="x5-page-mode" content="app">

  <link rel="stylesheet" type="text/css" href="style.css" />
  <!-- <link rel="icon" href="favicon.8de18.ico" /> -->
</head>

<body>
  <!-- ğŸ® éŠæˆ²ä¸»ç•«å¸ƒ -->
  <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="0"></canvas>

  <!-- ğŸ”„ Splash é–‹å ´å‹•ç•«èˆ‡é€²åº¦æ¢ -->
  <div id="splash">
    <img id="gameBG" src="gameBG.png" />
    <div class="background-container">
      <img id="logo-animation" src="logo/logo_000.png" alt="logo animation" />
      <div class="progress-bar stripes">
        <span style="width: 0%"></span>
      </div>
    </div>
  </div>

  <!-- âœ… é è¼‰ Logo å‹•ç•«è…³æœ¬ -->
  <script>
    const totalFrames = 104;
    const fps = 30;
    let currentFrame = 0;

    const img = document.getElementById('logo-animation');
    const splash = document.getElementById('splash');
    const frames = [];

    // é è¼‰å‹•ç•«åœ–ç‰‡
    for (let i = 0; i < totalFrames; i++) {
      const frame = new Image();
      frame.src = `logo/logo_${String(i).padStart(3, '0')}.png`;
      frames.push(frame);
    }

    // é–‹å§‹å‹•ç•«æ’­æ”¾
    const animationTimer = setInterval(() => {
      img.src = frames[currentFrame].src;
      currentFrame = (currentFrame + 1) % totalFrames;
    }, 1000 / fps);

    // å¯ç”± window.hideSplash() çµæŸ splash
    window.hideSplash = function () {
      splash.style.display = 'none';
      clearInterval(animationTimer);
      console.log('Splash hidden.');
    };
  </script>

  <!-- ğŸš€ æ ¸å¿ƒè¼‰å…¥èˆ‡å®¹éŒ¯è™•ç† -->
  <script>
    const failedResources = [];

    /**
     * ç”¨æ–¼è¼‰å…¥ JS è…³æœ¬ï¼Œæœ€å¤šé‡è©¦ N æ¬¡
     * @param {string} src - è…³æœ¬è·¯å¾‘
     * @param {number} retries - æœ€å¤§é‡è©¦æ¬¡æ•¸
     */
    function loadScriptWithRetry(src, retries = 3) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        let currentScript = null;

        function tryLoad() {
          attempts++;
          console.log(`ğŸ”„ å˜—è©¦è¼‰å…¥ï¼š${src} (ç¬¬ ${attempts} æ¬¡)`);

          if (currentScript) currentScript.remove();

          const script = document.createElement('script');
          script.async = false;
          script.src = `${src}?_v=${Date.now()}`; // é˜²æ­¢å¿«å–

          script.onload = () => {
            console.log(`âœ… æˆåŠŸè¼‰å…¥ï¼š${src}`);
            resolve();
          };

          script.onerror = () => {
            console.warn(`âŒ è¼‰å…¥å¤±æ•—ï¼š${src}`);
            if (attempts < retries) {
              setTimeout(tryLoad, 1000);
            } else {
              failedResources.push(src);
              reject(new Error(`è¶…éé‡è©¦æ¬¡æ•¸ï¼š${src}`));
            }
          };

          currentScript = script;
          document.body.appendChild(script);
        }

        tryLoad();
      });
    }

    /**
     * é¡¯ç¤ºéŒ¯èª¤æç¤ºè¦–çª—ï¼ˆåŒ…å«é‡æ–°æ•´ç†æŒ‰éˆ•ï¼‰
     * @param {string} message
     */
    function showReloadDialog(message) {
      if (document.getElementById('error-dialog')) return;

      const dialog = document.createElement('div');
      dialog.id = 'error-dialog';
      dialog.style.cssText = `
        position: fixed; top: 30%; left: 50%; transform: translateX(-50%);
        background: white; border: 1px solid #ccc; padding: 20px 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 9999;
        font-family: sans-serif; text-align: center;
      `;

      const text = document.createElement('div');
      text.innerText = message;
      text.style.marginBottom = '20px';

      const btn = document.createElement('button');
      btn.innerText = 'é‡æ–°æ•´ç†é é¢';
      btn.style.cssText = `
        padding: 8px 16px; font-size: 16px;
        background: #d33; color: white; border: none; border-radius: 4px;
        cursor: pointer;
      `;
      btn.onclick = () => window.location.reload();

      dialog.appendChild(text);
      dialog.appendChild(btn);
      document.body.appendChild(dialog);
    }

    /**
     * å•Ÿå‹•éŠæˆ²æµç¨‹ - å‹•æ…‹è¼‰å…¥æ‰€æœ‰å¿…è¦è…³æœ¬èˆ‡å¼•æ“
     */
    async function startGame() {
      let currentScript = '';
      try {
        currentScript = 'gameConfig.js';
        await loadScriptWithRetry(currentScript);

        currentScript = 'src/settings.js';
        await loadScriptWithRetry(currentScript);

        currentScript = 'main.js';
        await loadScriptWithRetry(currentScript);

        const debug = window._CCSettings.debug;
        const cocosScript = debug ? 'cocos2d-js.b78b6.js' : 'cocos2d-js-min.js';
        currentScript = cocosScript;
        await loadScriptWithRetry(cocosScript);

        // å¦‚æœä½¿ç”¨ç‰©ç†ç³»çµ±å†è¼‰å…¥ physics è…³æœ¬
        if (window.CC_PHYSICS_BUILTIN || window.CC_PHYSICS_CANNON) {
          const physicsScript = debug ? 'physics.8474b.js' : 'physics-min.js';
          currentScript = physicsScript;
          await loadScriptWithRetry(physicsScript);
        }

        // å•Ÿå‹•éŠæˆ²
        window.boot();

      } catch (err) {
        showReloadDialog(`âš ï¸ åŠ è¼‰ ${currentScript} å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šã€‚\n\néŒ¯èª¤ï¼š${err.message}`);
        console.error('[Game Start Error]', err);
      }
    }

    // ç­‰å¾… DOM çµæ§‹å®Œæˆå¾Œå•Ÿå‹•éŠæˆ²
    window.addEventListener('DOMContentLoaded', () => {
      const splash = document.getElementById('splash');
      if (splash) splash.style.display = 'block';
      startGame();
    });

    // æ¸…ç†å‹•ç•«è³‡æºèˆ‡å½±ç‰‡ï¼Œé¿å… unload æ™‚æ®˜ç•™
    window.addEventListener('beforeunload', () => {
      clearInterval(window.animationTimer);
      document.querySelectorAll('video').forEach(el => el.remove());
    });

    window.addEventListener('load', () => {
      document.querySelectorAll('video').forEach(el => el.remove());
    });

    // å•Ÿç”¨ vConsoleï¼ˆè‹¥æœ‰å¼•å…¥ï¼‰
    if (typeof VConsole !== 'undefined') {
      window.vConsole = new VConsole();
    }
  </script>
</body>

</html>