<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>MegaBingo</title>
  
  <!-- ğŸ¯ Favicon -->
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAABAAAAAAAAAAAADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7AD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA">
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAABAAAAAAAAAAAADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7ADs7AD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA">
  
  <!-- âœ… æ‰‹æ©Ÿèˆ‡è·¨ç€è¦½å™¨ç›¸å®¹æ€§è¨­å®š -->
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1, minimum-scale=1,maximum-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MegaBingo">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="renderer" content="webkit" />
  <meta name="force-rendering" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="msapplication-tap-highlight" content="no">
  <!-- <meta name="full-screen" content="yes" />
  <meta name="x5-fullscreen" content="true" />
  <meta name="360-fullscreen" content="true" /> -->
  <meta name="screen-orientation" content="portrait" />
  <meta name="x5-orientation" content="portrait">
  <meta name="x5-page-mode" content="app">
  
  <!-- ğŸŒ PWA æ”¯æŒ -->
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-navbutton-color" content="#000000">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
  <!-- ğŸ¬ TcPlayer è¦–é »å®¹å™¨ -->
  <div id="id_test_video" class="id-test-video"></div>
  <!-- ğŸ® éŠæˆ²ä¸»ç•«å¸ƒ -->
  <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="0"></canvas>

  <!-- ğŸ“± ç«–å±æç¤ºä¿¡æ¯ -->
  <div class="portrait-hint">
    <div>ç‚ºäº†æ›´å¥½çš„éŠæˆ²é«”é©—</div>
    <div>è«‹å°‡è¨­å‚™æ—‹è½‰è‡³è±å±æ¨¡å¼</div>
    <div style="font-size: 24px; margin-top: 10px;">ğŸ“±</div>
  </div>

  <!-- ğŸ–¥ï¸ PCç«¯æ¨ªå±æç¤ºä¿¡æ¯ -->
  <div class="landscape-hint">
    <div>ç‚ºäº†æ›´å¥½çš„éŠæˆ²é«”é©—</div>
    <div>è«‹å°‡çª—å£èª¿æ•´ç‚ºæ©«å±æ¨¡å¼</div>
    <div style="font-size: 24px; margin-top: 10px;">ğŸ–¥ï¸</div>
  </div>

  <!-- ğŸ”„ Splash é–‹å ´å‹•ç•«èˆ‡é€²åº¦æ¢ -->
  <div id="splash">
    <img id="gameBG" src="gameBG.png" />
    <div class="background-container">
      <canvas id="logo-canvas" src="logo/logo_000.png" alt="logo animation"></canvas>
      <div class="progress-bar stripes">
        <span style="width: 0%"></span>
      </div>
    </div>
  </div>


  <!-- ğŸ¬ é è¼‰ Logo å‹•ç•«è…³æœ¬ -->
  <script>
    const totalFrames = 104;
    const fps = 30;
    let currentFrame = 0;

    const canvas = document.getElementById('logo-canvas');
    const ctx = canvas.getContext('2d');
    const splash = document.getElementById('splash');

    const frames = [];
    let loadedCount = 0;
    let animationTimer = null;

    // ğŸ¯ çµ±ä¸€è¨­å‚™åˆ¤æ–·å‡½æ•¸ - ä½¿ç”¨èˆ‡ CommonTool.shouldUseMobileMode() ç›¸åŒçš„é‚è¼¯
    function getDeviceType() {
      const ua = navigator.userAgent || navigator.vendor || window.opera || '';
      const width = window.innerWidth;
      const height = window.innerHeight;
      const ratio = height / width;

      // åŸºæœ¬æ¢ä»¶åˆ¤æ–·
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const isPortrait = ratio > 1;
      const isSmallScreen = Math.min(width, height) <= 768;
      const isMobileUA = /android|iphone|ipad|ipod|windows phone/i.test(ua);

      // æ“´å±•æ¢ä»¶ï¼šåŒ…å«æ¨¡æ“¬å™¨çš„åˆ¤æ–·
      const hasPhoneLikeRatio = ratio > 1.2 && ratio < 2.5;
      const hasReasonableSize = width >= 320 && width <= 450 && height >= 550 && height <= 950;

      // çµ„åˆåˆ¤æ–·ï¼šåŸå§‹åˆ¤æ–· OR é¡ä¼¼æ‰‹æ©Ÿçš„æ¨¡æ“¬å™¨
      const isMobile = (isMobileUA || isTouchDevice) && isSmallScreen && isPortrait ||
                       (isTouchDevice && hasPhoneLikeRatio && hasReasonableSize);
      
      window.isMobile = isMobile;
      return {
        isMobile,
        isPC: !isMobile,
        screenWidth: width,
        screenHeight: height,
        ratio,
        userAgent: ua,
      };
    }

    // ğŸ¯ ä½¿ç”¨çµ±ä¸€çš„è¨­å‚™åˆ¤æ–·é‚è¼¯æ§åˆ¶èƒŒæ™¯åœ–ç‰‡é¡¯ç¤º
    function setupGameBackground() {
      const device = getDeviceType(); 
      // è¨­ç½® data-device å±¬æ€§ï¼Œè®“ CSS æ ¹æ“šè¨­å‚™é¡å‹æ‡‰ç”¨æ¨£å¼
      document.documentElement.setAttribute('data-device', device.isMobile ? 'mobile' : 'pc');
    }

    // åˆå§‹åŒ–èƒŒæ™¯è¨­ç½®
    setupGameBackground();

    // ç›£è½çª—å£å¤§å°è®ŠåŒ–ï¼Œé‡æ–°åˆ¤æ–·è¨­å‚™é¡å‹
    window.addEventListener('resize', () => {
      setupGameBackground();
    });

    // ç›£è½æ–¹å‘è®ŠåŒ–
    window.addEventListener('orientationchange', () => {
      setTimeout(setupGameBackground, 500);
    });

    for (let i = 0; i < totalFrames; i++) {
      const frame = new Image();
      const frameNumber = String(i).padStart(3, '0');
      frame.src = `logo/logo_${frameNumber}.png`;
      frame.onload = () => {
        loadedCount++;
        if (loadedCount === totalFrames) {
          startAnimation();
        }
      };
      frames.push(frame);
    }

    function startAnimation() {
      animationTimer = setInterval(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(frames[currentFrame], 0, 0, canvas.width, canvas.height);
        currentFrame = (currentFrame + 1) % totalFrames;
      }, 1000 / fps);
    }

    window.hideSplash = function () {
      splash.style.display = 'none';
      clearInterval(animationTimer);
    };
  </script>

  <!-- ğŸš€ æ ¸å¿ƒè½½å…¥ä¸å®¹é”™å¤„ç† -->
  <script>
    const failedResources = [];

    /**
     * ç”¨æ–¼è¼‰å…¥ JS è…³æœ¬ï¼Œæœ€å¤šé‡è©¦ N æ¬¡
     * @param {string} src - è…³æœ¬è·¯å¾‘
     * @param {number} retries - æœ€å¤§é‡è©¦æ¬¡æ•¸
     */
    function loadScriptWithRetry(src, retries = 3) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        let currentScript = null;

        function tryLoad() {
          attempts++;
          console.log(`ğŸ”„ å˜—è©¦è¼‰å…¥ï¼š${src} (ç¬¬ ${attempts} æ¬¡)`);

          if (currentScript) currentScript.remove();

          const script = document.createElement('script');
          script.async = false;
          script.src = `${src}?_v=${Date.now()}`; // é˜²å¿«å–

          script.onload = () => {
            console.log(`âœ… æˆåŠŸè¼‰å…¥ï¼š${src}`);
            resolve();
          };

          script.onerror = () => {
            console.warn(`âŒ è¼‰å…¥å¤±æ•—ï¼š${src}`);
            if (attempts < retries) {
              setTimeout(tryLoad, 1000); // å»¶é²é‡è©¦
            } else {
              failedResources.push(src);
              reject(new Error(`è¶…éé‡è©¦æ¬¡æ•¸ï¼š${src}`));
            }
          };

          currentScript = script;
          document.body.appendChild(script);
        }

        tryLoad();
      });
    }

    /**
     * é¡¯ç¤ºéŒ¯èª¤æç¤ºè¦–çª—ï¼ˆåŒ…å«é‡æ–°æ•´ç†æŒ‰éˆ•ï¼‰
     * @param {string} message
     */
    function showReloadDialog(message) {
      if (document.getElementById('error-dialog')) return;

      const dialog = document.createElement('div');
      dialog.id = 'error-dialog';
      dialog.style.cssText = `
        position: fixed; top: 30%; left: 50%; transform: translateX(-50%);
        background: white; border: 1px solid #ccc; padding: 20px 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 9999;
        font-family: sans-serif; text-align: center;
      `;

      const text = document.createElement('div');
      text.innerText = message;
      text.style.marginBottom = '20px';

      const btn = document.createElement('button');
      btn.innerText = 'é‡æ–°æ•´ç†é é¢';
      btn.style.cssText = `
        padding: 8px 16px; font-size: 16px;
        background: #d33; color: white; border: none; border-radius: 4px;
        cursor: pointer;
      `;
      btn.onclick = () => window.location.reload();

      dialog.appendChild(text);
      dialog.appendChild(btn);
      document.body.appendChild(dialog);
    }

    /**
     * å•Ÿå‹•éŠæˆ²æµç¨‹ - å‹•æ…‹è¼‰å…¥æ‰€æœ‰å¿…è¦è…³æœ¬
     */
    async function startGame() {
      
      let currentScript = ''; // ç”¨æ–¼éŒ¯èª¤æç¤º
      try {
        // ğŸ” åŠ è½½è§£å¯†ç›¸å…³ä¾èµ–
        const cryptoLibs = [
          'https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.3.0/js/md5.min.js',
          'url-decrypt.js'
        ];
        
        for (const lib of cryptoLibs) {
          currentScript = lib;
          await loadScriptWithRetry(currentScript);
        }

        // ğŸ” ç­‰å¾…URLè§£å¯†å®Œæˆ
        if (typeof window.waitForUrlDecryption === 'function') {
          await window.waitForUrlDecryption(5000);
        } else {
          showReloadDialog(`éŠæˆ²è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡æ–°æ•´ç†é é¢ã€‚`);
        }

        // ğŸ® åŠ è½½æ¸¸æˆæ¨¡å—
        const gameModules = [
          'gameConfig.js',
          'settings.js', 
          'main.js',
          '/socket.io/socket.io.js',
          'app/engine/bin/<%=cocos2d%>',
          'preview-scripts/__quick_compile__.js'
        ];
        
        for (const module of gameModules) {
          currentScript = module;
          await loadScriptWithRetry(currentScript);
        }

        console.log('ğŸ‰ æ¸¸æˆå¯åŠ¨æˆåŠŸï¼');

      } catch (err) {
        showReloadDialog(`éŠæˆ²è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡æ–°æ•´ç†é é¢ã€‚`);
        console.error('[Game Start Error]', err);
      }
    }

    // ğŸ”„ å¼ºåˆ¶å±å¹•æ–¹å‘æ˜¾ç¤ºå‡½æ•° - ç§»åŠ¨ç«¯ç«–å±ï¼ŒPCç«¯æ¨ªå±
    function enforcePortraitMode() {
      const device = getDeviceType();
      const screenWidth = device.screenWidth;
      const screenHeight = device.screenHeight;
      
      const body = document.body;
      const canvas = document.getElementById('GameCanvas');
      const splash = document.getElementById('splash');
      
      // æ¸…é™¤æ‰€æœ‰æ—‹è½‰é¡ï¼Œé¿å…è¡çª
      body.classList.remove('force-portrait', 'force-landscape');
      if (canvas) canvas.classList.remove('force-portrait', 'force-landscape');
      if (splash) splash.classList.remove('force-portrait', 'force-landscape');
      
      if (device.isMobile) {
        // ğŸ“± ç§»åŠ¨ç«¯å¼ºåˆ¶ç«–å±
        const isLandscape = screenWidth > screenHeight;
        
        if (isLandscape) {
          // æ¨ªå±æ—¶å¼ºåˆ¶æ—‹è½¬ä¸ºç«–å±æ˜¾ç¤º
          console.log('ğŸ“± ç§»å‹•ç«¯ï¼šæª¢æ¸¬åˆ°æ©«å±ï¼Œå¼·åˆ¶æ—‹è½‰ç‚ºè±å±');
          body.classList.add('force-portrait');
          if (canvas) canvas.classList.add('force-portrait');
          if (splash) splash.classList.add('force-portrait');
        } else {
          // console.log('ğŸ“± ç§»å‹•ç«¯ï¼šè±å±æ¨¡å¼ï¼Œæ­£å¸¸é¡¯ç¤º');
        }
      } else {
        // ğŸ–¥ï¸ PCç«¯
      }
    }

    // ğŸ–¼ï¸ è°ƒæ•´ç”»å¸ƒå¤§å°
    function adjustCanvasSize() {
      const canvas = document.getElementById('GameCanvas');
      if (canvas) {
        // ä½¿ç”¨ CSS ç¡®ä¿ç”»å¸ƒå¡«æ»¡å±å¹•
        canvas.style.width = '100vw';
        canvas.style.height = '100vh';
        
        // å¯¹äº iOS Safari
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          canvas.style.height = '-webkit-fill-available';
        }
      }
    }

    // DOM çµæ§‹å®Œæˆå¾Œå•Ÿå‹•éŠæˆ²
    window.addEventListener('DOMContentLoaded', () => {
      // ğŸ® å¯åŠ¨æ¸¸æˆ
      startGame();
    });

    // ğŸ–¥ï¸ æ–¹å‘å˜åŒ–å¤„ç†
    window.addEventListener('resize', () => {
      adjustCanvasSize();
      enforcePortraitMode();
    });

    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        const device = getDeviceType();
        
        if (device.isMobile) {
          // ç§»åŠ¨è®¾å¤‡å¤„ç†
          window.scrollTo(0, 1);
          adjustCanvasSize();
        }
        
        // å¼ºåˆ¶å±å¹•æ–¹å‘å¤„ç† - ç§»åŠ¨ç«¯ç«–å±ï¼ŒPCç«¯æ¨ªå±
        enforcePortraitMode();
      }, 500);
    });

    // æ¸…ç†å‹•ç•«è³‡æºèˆ‡å½±ç‰‡ï¼Œé¿å… unload æ™‚æ®˜ç•™
    window.addEventListener('beforeunload', () => {
      clearInterval(animationTimer);
      document.querySelectorAll('video').forEach(el => el.remove());
    });

    window.addEventListener('load', () => {
      document.querySelectorAll('video').forEach(el => el.remove());
    });
    
    // æ›è¼‰åˆ°å…¨åŸŸ window ç‰©ä»¶ï¼Œè®“å…¶ä»–è…³æœ¬èƒ½ä½¿ç”¨
    window.showReloadDialog = showReloadDialog; 

    // å•Ÿç”¨ vConsoleï¼ˆè‹¥æœ‰å¼•å…¥ï¼‰
    if (typeof VConsole !== 'undefined') {
      window.vConsole = new VConsole();
    }
  </script>
</body>

</html>
